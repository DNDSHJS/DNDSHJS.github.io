<!DOCTYPE html>
<html>
<head>
    <title>D&D 伤害计算器</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #damageDistributionChart {
            max-width: 400px;
            max-height: 400px;
            margin: auto;
            display: block;
        }
    </style>
</head>
<body>
    <h2>D&D 伤害期望计算器</h2>
    <p>输入骰子公式如：2d10+5。若要加入易伤与抗性则在后面加入v,r。如2d10r+5v，加值若有抗性或易伤则也要在后面加入r或v（'v'表示易伤，'r'表示抗性）:</p>
    <input type="text" id="diceExpression" placeholder="2d10+5">
    <div>
        <input type="radio" id="none" name="advantageDisadvantage" value="none" checked> 无
        <input type="radio" id="advantage" name="advantageDisadvantage" value="advantage"> 重骰取高
        <input type="radio" id="disadvantage" name="advantageDisadvantage" value="disadvantage"> 重骰取低
    </div>
    <button onclick="calculateDamage()">Calculate</button>
    <p id="result"></p>
    <canvas id="damageDistributionChart"></canvas>

    <script>
        function calculateDamage() {
            var hasAdvantage = document.getElementById('advantage').checked;
            var hasDisadvantage = document.getElementById('disadvantage').checked;
            simulateDiceRolls(hasAdvantage, hasDisadvantage); // 总是进行模拟以更新图表
        }

        function simulateDiceRolls(hasAdvantage, hasDisadvantage) {
            var expression = document.getElementById('diceExpression').value;
            var parts = expression.split('+');
            var maxDamage = 0;
            var totalExpectation = 0; // 用于非优势/劣势情况下的期望计算

            parts.forEach(part => {
                var modifier = 1;
                var baseValue = 0; // 直接加值或骰子基础值

                if (part.endsWith('v')) {
                    modifier = 2;
                    part = part.slice(0, -1);
                } else if (part.endsWith('r')) {
                    modifier = 0.5;
                    part = part.slice(0, -1);
                }

                if (part.includes('d')) {
                    var [numDice, diceSides] = part.split('d').map(Number);
                    baseValue = numDice * (diceSides + 1) / 2;
                    maxDamage += (numDice * diceSides) * modifier;
                } else {
                    baseValue = Number(part);
                    maxDamage += baseValue * modifier;
                }

                totalExpectation += baseValue * modifier;
            });

            var results = new Array(maxDamage + 1).fill(0);
            var simulationCount = 1000000;

            // 进行模拟
            for (var i = 0; i < simulationCount; i++) {
                var totalDamage = simulateDamage(parts, hasAdvantage, hasDisadvantage);
                results[Math.min(Math.floor(totalDamage), maxDamage)]++;
            }

            if (!hasAdvantage && !hasDisadvantage) {
                // 无优势/劣势时显示计算期望
                document.getElementById('result').innerHTML = "Expected Damage: " + totalExpectation.toFixed(2);
            } else {
                // 显示模拟中最可能的伤害值
                var maxCount = Math.max(...results);
                var mostLikelyDamage = results.indexOf(maxCount);
                document.getElementById('result').innerHTML = "Most likely simulated damage: " + mostLikelyDamage;
            }

            var percentages = results.map(count => (count / simulationCount) * 100);

            var ctx = document.getElementById('damageDistributionChart').getContext('2d');
            if (window.barChart != undefined) {
                window.barChart.destroy();
            }
            window.barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: maxDamage + 1}, (_, i) => i + 1),
                    datasets: [{
                        label: 'Damage Probability (%)',
                        data: percentages,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + "%";
                                }
                            }
                        }
                    },
                    maintainAspectRatio: false
                }
            });
        }

        function simulateDamage(parts, hasAdvantage, hasDisadvantage) {
            var totalDamage = 0;
            parts.forEach(part => {
                var modifier = 1;
                if (part.endsWith('v')) {
                    modifier = 2;
                    part = part.slice(0, -1);
                } else if (part.endsWith('r')) {
                    modifier = 0.5;
                    part = part.slice(0, -1);
                }

                if (part.includes('d')) {
                    var [numDice, diceSides] = part.split('d').map(Number);
                    for (var j = 0; j < numDice; j++) {
                        var roll1 = Math.floor(Math.random() * diceSides) + 1;
                        var roll2 = Math.floor(Math.random() * diceSides) + 1;
                        var effectiveRoll = roll1;

                        if (hasAdvantage) {
                            effectiveRoll = Math.max(roll1, roll2);
                        } else if (hasDisadvantage) {
                            effectiveRoll = Math.min(roll1, roll2);
                        }

                        totalDamage += effectiveRoll;
                    }
                } else {
                    totalDamage += Number(part);
                }
                totalDamage *= modifier;
            });
            return totalDamage;
        }//芝士彩蛋。奖励你一个银。
    </script>
</body>
</html>





#自动侏儒会跑ai团吗？出品。有任何问题概不负责（确信）
